<div class="edi-reports-container">
  <!-- Top header bar -->
  <header class="edi-header">
    <div class="header-left">
      <label class="header-label">Connection:</label>
      <select [(ngModel)]="selectedConnectionId" class="header-dropdown" (ngModelChange)="loadReports()">
        <option value="">-- Select --</option>
        <option *ngFor="let c of connections" [value]="c.id">{{ c.name }}</option>
      </select>
      <span class="header-hint">Double click to View</span>
    </div>
    <div class="header-right">
      <div class="search-row">
        <input type="text" class="search-input" [(ngModel)]="filterText" placeholder="Search for Keyword" />
        <button type="button" class="btn btn-clear" (click)="filterText = ''">Clear</button>
        <button type="button" class="btn btn-icon" title="Search" aria-label="Search">
          <span class="icon-search">⌕</span>
        </button>
      </div>
      <div class="header-actions">
        <button type="button" class="btn btn-action" (click)="openSelected()" [disabled]="!singleSelected">Open</button>
        <button type="button" class="btn btn-action" (click)="saveNotesSelected()" [disabled]="!singleSelected">Save Notes</button>
        <button type="button" class="btn btn-action" (click)="exportSelected()" [disabled]="!singleSelected">Export File</button>
      </div>
    </div>
  </header>

  <div *ngIf="error" class="error-bar">{{ error }}</div>

  <!-- Main content: grid + quick view -->
  <div class="main-body">
    <div class="content-area">
      <!-- Grouping bar -->
      <div class="grouping-bar">
        <span class="grouping-hint">Drag a column header here to group by that column</span>
      </div>

      <!-- Reports grid -->
      <div class="grid-wrapper">
        <table class="reports-grid">
          <thead>
            <tr class="header-row">
              <th class="col-check"><input type="checkbox" [checked]="isAllChecked" (change)="toggleCheckAll()" [indeterminate]="isSomeChecked" title="Check All" /></th>
              <th (click)="sortBy('fileName')" class="sortable">Name</th>
              <th (click)="sortBy('createdAt')" class="sortable">Date Created</th>
              <th (click)="sortBy('fileType')" class="sortable">Type</th>
              <th (click)="sortBy('fileSize')" class="sortable">Size</th>
              <th (click)="sortBy('note')" class="sortable">Note</th>
              <th (click)="sortBy('payerName')" class="sortable">Payer</th>
              <th (click)="sortBy('paymentAmount')" class="sortable">Pmt Amt</th>
              <th>Date</th>
              <th (click)="sortBy('traceNumber')" class="sortable">Trace Number</th>
              <th (click)="sortBy('direction')" class="sortable">Method</th>
            </tr>
            <tr class="filter-row">
              <th class="col-check"></th>
              <th><input type="text" class="col-filter" [(ngModel)]="colFilters['fileName']" (ngModelChange)="0" placeholder="Filter" /></th>
              <th><input type="text" class="col-filter" [(ngModel)]="colFilters['createdAt']" (ngModelChange)="0" placeholder="Filter" /></th>
              <th><input type="text" class="col-filter" [(ngModel)]="colFilters['fileType']" (ngModelChange)="0" placeholder="Filter" /></th>
              <th><input type="text" class="col-filter" [(ngModel)]="colFilters['fileSize']" (ngModelChange)="0" placeholder="Filter" /></th>
              <th><input type="text" class="col-filter" [(ngModel)]="colFilters['note']" (ngModelChange)="0" placeholder="Filter" /></th>
              <th><input type="text" class="col-filter" [(ngModel)]="colFilters['payerName']" (ngModelChange)="0" placeholder="Filter" /></th>
              <th><input type="text" class="col-filter" [(ngModel)]="colFilters['paymentAmount']" (ngModelChange)="0" placeholder="Filter" /></th>
              <th><input type="text" class="col-filter" [(ngModel)]="colFilters['date']" (ngModelChange)="0" placeholder="Filter" /></th>
              <th><input type="text" class="col-filter" [(ngModel)]="colFilters['traceNumber']" (ngModelChange)="0" placeholder="Filter" /></th>
              <th><input type="text" class="col-filter" [(ngModel)]="colFilters['direction']" (ngModelChange)="0" placeholder="Filter" /></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="loading"><td colspan="11" class="loading-cell">Loading...</td></tr>
            <tr *ngFor="let r of filteredReports" (dblclick)="onRowDoubleClick(r)" [class.archived]="r.isArchived" [class.unread]="!r.isRead" [class.selected]="isChecked(r)">
              <td class="col-check"><input type="checkbox" [checked]="isChecked(r)" (change)="toggleCheck(r)" (click)="$event.stopPropagation()" /></td>
              <td>{{ r.fileName }}</td>
              <td>{{ r.createdAt | date:'short' }}</td>
              <td>{{ r.fileType }}</td>
              <td>{{ formatFileSize(r.fileSize) }}</td>
              <td>{{ r.note || '—' }}</td>
              <td>{{ r.payerName || '—' }}</td>
              <td>{{ r.paymentAmount != null ? (r.paymentAmount | number:'1.2-2') : '—' }}</td>
              <td>{{ dateDisplay(r) }}</td>
              <td>{{ r.traceNumber || '—' }}</td>
              <td>{{ r.direction }}</td>
            </tr>
            <tr *ngIf="!loading && filteredReports.length === 0"><td colspan="11" class="empty-cell">No reports.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Quick View panel (always visible) -->
      <div class="quick-view-panel">
        <p class="quick-view-hint">Double click the report file to view the contents.</p>
        <div class="quick-view-content">
          <ng-container *ngIf="!previewContent && !quickViewMessage">
            <span class="quick-view-placeholder">Select a report to preview.</span>
          </ng-container>
          <ng-container *ngIf="quickViewMessage">
            <span class="quick-view-message">{{ quickViewMessage }}</span>
          </ng-container>
          <pre *ngIf="previewContent && !quickViewMessage" class="quick-view-pre">{{ previewContent }}</pre>
        </div>
      </div>
    </div>

    <!-- Right sidebar -->
    <aside class="sidebar">
      <div class="sidebar-receiver" *ngIf="receivers.length">
        <label class="sidebar-label">Receiver:</label>
        <select [(ngModel)]="selectedReceiverId" class="sidebar-dropdown">
          <option value="">-- Select --</option>
          <option *ngFor="let r of receivers" [value]="r.id">{{ r.libraryEntryName }}</option>
        </select>
      </div>
      <button type="button" class="btn btn-sidebar" (click)="getReports()" [disabled]="loading || !selectedConnectionId || !selectedReceiverId">Get Reports</button>
      <button type="button" class="btn btn-sidebar" (click)="openAddForm()">Add Reports</button>
      <button type="button" class="btn btn-sidebar" (click)="refreshReports()" [disabled]="loading">Refresh Reports</button>
      <button type="button" class="btn btn-sidebar" (click)="close()">Close</button>

      <div class="sidebar-divider"></div>

      <div class="sidebar-check-all" (click)="$event.stopPropagation()">
        <button type="button" class="btn btn-sidebar btn-dropdown" (click)="showCheckAllMenu = !showCheckAllMenu; $event.stopPropagation()">
          Check All <span class="dropdown-arrow">▼</span>
        </button>
        <ul class="dropdown-menu" *ngIf="showCheckAllMenu">
          <li><a href="#" (click)="checkAll(); $event.preventDefault()">Check All</a></li>
          <li><a href="#" (click)="checkNone(); $event.preventDefault()">Check None</a></li>
        </ul>
      </div>
      <label class="sidebar-checkbox">
        <input type="checkbox" [(ngModel)]="showArchived" (ngModelChange)="loadReports()" />
        Show Archived
      </label>

      <div class="sidebar-label">Apply to Checked</div>
      <button type="button" class="btn btn-sidebar btn-dropdown" (click)="archiveChecked()" [disabled]="checkedIds.size === 0">
        Archive <span class="dropdown-arrow">▼</span>
      </button>
      <button type="button" class="btn btn-sidebar btn-danger" (click)="deleteChecked()" [disabled]="checkedIds.size === 0">Delete</button>
    </aside>
  </div>

  <!-- Modals -->
  <div *ngIf="showAddForm" class="modal-overlay" (click)="cancelAddForm()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>Add Reports (Generate 837/270)</h3>
      <div *ngIf="addFormError" class="error-text">{{ addFormError }}</div>
      <div class="form-row">
        <label>Receiver:</label>
        <select [(ngModel)]="addForm.receiverLibraryId" class="form-input">
          <option value="">-- Select --</option>
          <option *ngFor="let r of receivers" [value]="r.id">{{ r.libraryEntryName }}</option>
        </select>
      </div>
      <div class="form-row">
        <label>Claim ID:</label>
        <input type="number" [(ngModel)]="addForm.claimId" class="form-input" min="1" />
      </div>
      <div class="form-row">
        <label>File type:</label>
        <select [(ngModel)]="addForm.fileType" class="form-input">
          <option value="837">837</option>
          <option value="270">270</option>
        </select>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-primary" (click)="submitAddForm()" [disabled]="addFormSaving">Generate</button>
        <button type="button" class="btn btn-secondary" (click)="cancelAddForm()">Cancel</button>
      </div>
    </div>
  </div>

  <div *ngIf="showNoteModal" class="modal-overlay" (click)="cancelNoteEdit()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>Edit Note</h3>
      <div class="form-row">
        <label>Note (max 255 characters):</label>
        <textarea [(ngModel)]="noteEditText" class="form-input" rows="4" maxlength="255"></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-primary" (click)="saveNote()" [disabled]="noteSaving">Save Notes</button>
        <button type="button" class="btn btn-secondary" (click)="cancelNoteEdit()">Cancel</button>
      </div>
    </div>
  </div>
</div>
