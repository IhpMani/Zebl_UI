<div class="claim-list-container">
  <h2>Claim List</h2>

  <div *ngIf="loading" class="loading">Loading claims...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <div *ngIf="!loading && !error">
    <table class="claims-table">
      <thead>
        <tr>
          <th class="action-col add-column-header">
            <div class="header-cell">
              <button class="add-column-btn" (click)="toggleCustomizationDialog()" title="Add Column">
                Add Column <span class="arrow">▼</span>
              </button>
            </div>
            <div class="filter-row">
              <div class="filter-placeholder"></div>
            </div>
          </th>
          <th *ngFor="let col of visibleColumns">
            <div class="header-cell">
              <span>{{ col.label }}</span>
              <button class="hide-col-btn" (click)="hideColumn(col.key)" title="Hide column">×</button>
            </div>
            <div class="filter-row">
              <button class="filter-popup-btn" (click)="openFilterPopup(col.key, $event)" title="Filter">
                Filter <span class="arrow">▼</span>
              </button>
              <button
                class="clear-filter-btn"
                *ngIf="columnValueFilters[col.key]"
                (click)="clearFilter(col.key, $event)"
                title="Clear filter"
              >
                ✕
              </button>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let claim of filteredClaims" (click)="onRowClick(claim)" class="claim-row">
          <td class="action-col">
            <button class="open-btn" (click)="$event.stopPropagation(); onRowClick(claim)">
              Open
            </button>
          </td>
          <td *ngFor="let col of visibleColumns">
            <ng-container [ngSwitch]="col.key">
              <span *ngSwitchCase="'claDateTimeCreated'">
                {{ claim.claDateTimeCreated | date:'short' }}
              </span>
              <span *ngSwitchCase="'claTotalChargeTRIG'">
                {{ claim.claTotalChargeTRIG | currency:'USD':'symbol':'1.2-2' }}
              </span>
              <span *ngSwitchCase="'claTotalBalanceCC'">
                {{ claim.claTotalBalanceCC | currency:'USD':'symbol':'1.2-2' }}
              </span>
              <span *ngSwitchDefault>
                {{ getCellValue(claim, col.key) }}
              </span>
            </ng-container>
          </td>
        </tr>
        <tr *ngIf="filteredClaims.length === 0 && !loading">
          <td [attr.colspan]="visibleColumns.length + 1" class="no-data">No claims found</td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="meta" class="pagination-container">
      <div class="pagination-info">
        Showing {{ filteredClaims.length }} of {{ meta.totalCount }} claims
        (Page {{ meta.page }} of {{ getTotalPages() }})
      </div>
      <div class="pagination-controls">
        <button 
          class="pagination-btn" 
          (click)="onPageChange(1)"
          [disabled]="meta.page === 1 || loading"
          title="First page">
          ««
        </button>
        <button 
          class="pagination-btn" 
          (click)="onPageChange(meta.page - 1)"
          [disabled]="meta.page === 1 || loading"
          title="Previous page">
          ‹
        </button>
        <span class="page-info">Page {{ meta.page }} of {{ getTotalPages() }}</span>
        <button 
          class="pagination-btn" 
          (click)="onPageChange(meta.page + 1)"
          [disabled]="meta.page >= getTotalPages() || loading"
          title="Next page">
          ›
        </button>
        <button 
          class="pagination-btn" 
          (click)="onPageChange(getTotalPages())"
          [disabled]="meta.page >= getTotalPages() || loading"
          title="Last page">
          »»
        </button>
        <select 
          class="page-size-select"
          [value]="pageSize"
          (change)="onPageSizeChange(+$any($event.target).value)"
          [disabled]="loading">
          <option value="10">10 per page</option>
          <option value="25">25 per page</option>
          <option value="50">50 per page</option>
          <option value="100">100 per page</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Filter Popup -->
  <div class="filter-popup-overlay" *ngIf="showFilterPopup" (click)="closeFilterPopup($event)">
    <div
      class="filter-popup"
      (click)="$event.stopPropagation()"
      [style.top.px]="filterPopupPosition.topPx"
      [style.left.px]="filterPopupPosition.leftPx"
    >
      <div class="filter-popup-tabs">
        <button class="tab active">Values</button>
      </div>

      <!-- Text/Numeric Input for numeric columns -->
      <div *ngIf="activeFilterColumnKey && isNumericColumn(activeFilterColumnKey)" class="filter-popup-input">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
          {{ getColumnLabel(activeFilterColumnKey) }}
        </label>
        <input
          type="text"
          [(ngModel)]="popupTextFilter"
          [placeholder]="activeFilterColumnKey === 'claID' ? 'Enter Claim ID (e.g., 123456 or 123,456,789)' : 'Enter value(s), comma-separated'"
          style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"
          (keyup.enter)="applyValueFilterAndClose()"
        />
        <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
          <span *ngIf="activeFilterColumnKey === 'claID'">Enter one or more Claim IDs, separated by commas</span>
          <span *ngIf="activeFilterColumnKey !== 'claID'">Enter one or more values, separated by commas</span>
        </div>
      </div>

      <!-- Checkbox-based filter for non-numeric columns -->
      <div *ngIf="!activeFilterColumnKey || !isNumericColumn(activeFilterColumnKey)">
        <div class="filter-popup-search">
          <input
            type="text"
            [(ngModel)]="filterPopupSearchText"
            placeholder="Enter text to search..."
          />
        </div>

        <div class="filter-popup-values">
          <label class="value-item">
            <input type="checkbox" [checked]="isPopupAllSelected()" (change)="onPopupAllChange($event)" />
            <span>(All)</span>
          </label>

          <label *ngFor="let v of getFilterValuesForActiveColumn()" class="value-item">
            <input
              type="checkbox"
              [checked]="isPopupValueChecked(v)"
              (change)="onPopupValueChange(v, $event)"
            />
            <span>{{ v }}</span>
          </label>
        </div>
      </div>

      <div class="filter-popup-actions">
        <button class="btn-secondary" (click)="clearActiveColumnFilter()">Clear Filter</button>
        <button class="btn-primary" (click)="applyValueFilterAndClose()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Customization Dialog -->
  <div class="customization-overlay" *ngIf="showCustomizationDialog" (click)="closeCustomizationDialog($event)">
    <div class="customization-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h3>Add Column</h3>
        <button class="close-btn" (click)="closeCustomizationDialog()">×</button>
      </div>
      <div class="dialog-search">
        <input
          type="text"
          [(ngModel)]="columnSearchText"
          placeholder="Search for a column..."
          class="search-input"
        />
      </div>
      <div class="dialog-content">
        <!-- Curated Additional Columns (Categorized) -->
        <div *ngFor="let category of getAdditionalColumnCategories()" class="column-section">
          <h4>{{ category }}</h4>
          <div class="column-list">
            <label *ngFor="let col of getAdditionalColumnsByCategory(category)" class="column-item">
              <input
                type="checkbox"
                [checked]="isAdditionalColumnSelected(col.key)"
                (change)="toggleColumnVisibility(col.key)"
              />
              <span>{{ col.label }}</span>
              <span *ngIf="col.isForeignKey" class="fk-badge" title="Foreign Key Reference">FK</span>
            </label>
          </div>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="clear-all-btn" (click)="clearAllColumns()">Clear All</button>
      </div>
    </div>
  </div>
</div>
